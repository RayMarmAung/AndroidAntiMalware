Imports System.IO
Imports Telecom.Android
Module Report
    Public Sub ReportLogFile()

        'get date

        Dim logTitle As String = infoProductName.Replace(" ", "_").Replace("/", "") & "_" & Now.ToString("yyyyMMddHHmm") & ".log"

        If Not ReportChecksum = "" Then
            Using r As New StreamWriter("important.txt")
                r.Write(getDatefromFile)
                r.Close()
            End Using

            Using r As New StreamWriter("rawlist.txt")
                r.Write(rawListEditor)
                r.Close()
            End Using

            Zip.Run7zCommand("a TmpStr.bin important.txt rawlist.txt -pTELEComTechAV77813&&*!#")

            If File.Exists("important.txt") Then File.Delete("important.txt")
            If File.Exists("rawlist.txt") Then File.Delete("rawlist.txt")

            If File.Exists("TmpStr.bin") Then
                EncryptOrDecryptFile("TmpStr.bin", logTitle, CryptoFileAction.ActionEncrypt)
                File.Delete("TmpStr.bin")
            End If

            If Not Directory.Exists("Logs") Then
                Directory.CreateDirectory("Logs")
                If File.Exists(logTitle) Then File.Move(logTitle, "Logs\" & logTitle)
            Else
                If File.Exists(logTitle) Then File.Move(logTitle, "Logs\" & logTitle)
            End If

        End If

    End Sub
    Public Function getDatefromFile() As String

        'get all date and time ********************************************
        Dim dateString As String = ""

        Using r As New StringReader(RawList)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                If line.StartsWith("-rw") Then
                    Dim spl() As String = line.Split(" ")
                    Dim fileDate As String = ""

                    If spl(spl.Length - 3).Contains("-") Then
                        fileDate = spl(spl.Length - 3) '& " " & spl(spl.Length - 2)
                    ElseIf spl(spl.Length - 4).Contains("-") Then
                        fileDate = spl(spl.Length - 4) '& " " & spl(spl.Length - 3)
                    ElseIf spl(spl.Length - 5).Contains("-") Then
                        fileDate = spl(spl.Length - 5) '& " " & spl(spl.Length - 4)
                    End If

                    If Not fileDate = "" Then
                        If dateString = "" Then
                            dateString = fileDate
                        Else
                            If Not dateString.Contains(fileDate) Then
                                dateString += vbNewLine & fileDate
                            End If
                        End If
                    End If

                End If

            End While
        End Using

        'get date and time which is less than 50 *****************************
        Dim index As Integer
        Dim tempDateString As String = ""

        Using r As New StringReader(dateString)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                index = 0

                Using s As New StringReader(RawList)
                    Dim linc As String

                    While Not s.Peek = -1
                        linc = s.ReadLine

                        If linc.Contains(line) Then
                            index += 1
                        End If

                    End While
                End Using

                If index < 70 Then
                    If tempDateString = "" Then
                        tempDateString = line
                    Else
                        tempDateString += vbNewLine & line
                    End If
                End If

            End While
        End Using

        'get all files in selected date and time ***************************
        Dim tempFile As String = ""

        Using r As New StringReader(tempDateString)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                Using s As New StringReader(RawList)
                    Dim linc As String

                    While Not s.Peek = -1
                        linc = s.ReadLine

                        If linc.StartsWith("-rw") Then
                            If Not linc.EndsWith(".odex") Then
                                If linc.Contains(line) Then

                                    Dim spr() As String = linc.Split(" ")
                                    Dim fName As String = spr(spr.Length - 1)

                                    If tempFile = "" Then
                                        tempFile = fName
                                    Else
                                        tempFile += vbNewLine & fName
                                    End If

                                End If
                            End If
                        End If

                    End While
                End Using


            End While
        End Using

        'get file with checksum on selected date and time
        Dim checksumBaby As String = ""

        Using r As New StringReader(tempFile)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                Using s As New StringReader(ReportChecksum)
                    Dim linc As String

                    While Not s.Peek = -1
                        linc = s.ReadLine

                        If linc.Contains(line) Then
                            If checksumBaby = "" Then
                                checksumBaby = linc
                            Else
                                checksumBaby += vbNewLine & linc
                            End If
                            Exit While
                        End If
                    End While
                End Using

            End While
        End Using

        Return checksumBaby
    End Function
    Private Function rawListEditor() As String

        Dim list As String = ""
        Dim path As String = ""

        Using r As New StringReader(RawList)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                If line.StartsWith("/") Then
                    path = line.Replace(":", "/")
                    If path.Contains("//") Then path = path.Replace("//", "/")
                ElseIf line.StartsWith("-rw") Then
                    Dim spl() As String = line.Split(" ")
                    Dim file As String = spl(spl.Length - 1)

                    Dim hash As String = searchFileHash(path & file)

                    If Not hash = "" Then
                        If list = "" Then
                            list = path & " " & line & " > " & hash
                        Else
                            list += vbNewLine & path & " " & line & " > " & hash
                        End If
                    End If

                End If

            End While
        End Using

        Return list
    End Function
    Private Function searchFileHash(cfile As String) As String

        Dim result As String = ""

        Using r As New StringReader(ReportChecksum)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                If line.Contains(cfile) Then
                    result = line.Substring(line.IndexOf(">") + 2)
                    Exit While
                End If

            End While
        End Using

        Return result
    End Function

End Module
