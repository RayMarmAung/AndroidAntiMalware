Imports System.ComponentModel
Imports System.IO
Imports Telecom.Android
Public Class ApkInfo

    Private WithEvents bwkInfo As New BackgroundWorker
    Private ApkName As String
    Private ApkPackage As String
    Private ApkIcon As String
    Private ApkStatus As String = "Idle"
    Private pkgStatus As String = "Idle"
    Public allPkgNames As String
    Public allProcNames As String
    Friend ReadOnly Property Name() As String
        Get
            Return ApkName
        End Get
    End Property
    Friend ReadOnly Property Package() As String
        Get
            Return ApkPackage
        End Get
    End Property
    Friend ReadOnly Property Icon() As String
        Get
            Return ApkIcon
        End Get
    End Property
    Friend ReadOnly Property Status() As String
        Get
            Return ApkStatus
        End Get
    End Property
    Friend ReadOnly Property PackageStatus() As String
        Get
            Return pkgStatus
        End Get
    End Property
    Friend Sub New()

    End Sub
    Public Sub Start()

        'get all packages name in one time
        If allPkgNames = "" Then

            Dim bwkallPkgName As New BackgroundWorker
            AddHandler bwkallPkgName.DoWork, New DoWorkEventHandler(AddressOf getAllPkgNames)
            bwkallPkgName.RunWorkerAsync()

            While bwkallPkgName.IsBusy
                Application.DoEvents()
                Threading.Thread.Sleep(100)
            End While

        End If

        'formal tasks
        With bwkInfo
            .WorkerSupportsCancellation = True
            If Not .IsBusy Then .RunWorkerAsync()

            While .IsBusy
                Application.DoEvents()
                Threading.Thread.Sleep(100)
            End While

            If Not ApkIcon = "NoIcon" Then

                If File.Exists("Temp\" & ApkIcon) Then
                    ImageStream = New FileStream("Temp\" & ApkIcon, FileMode.Open, FileAccess.Read)
                    Form1.ImageListLarge.Images.Add(ApkIcon, Image.FromStream(ImageStream))
                    ImageStream.Close()
                    File.Delete("Temp\" & ApkIcon)
                Else
                    ApkIcon = "NoIcon"
                End If
            End If

        End With
    End Sub
    Private Sub bwkInfo_DoWork(sender As Object, e As DoWorkEventArgs) Handles bwkInfo.DoWork
        If Not bwkInfo.CancellationPending Then

            ApkIcon = "NoIcon"
            ApkName = "Unknown"
            ApkPackage = "Cracked"
            ApkStatus = "Idle"

            Dim bbCmd As String = Aapt.RunAaptCommand("dump badging Temp\" & currentName)

            Using r As New StringReader(bbCmd)
                Dim line As String

                While Not r.Peek = -1
                    line = r.ReadLine

                    If line.Contains("package: name=") Then
                        ApkPackage = line.Substring(line.IndexOf("=") + 1)
                        ApkPackage = ApkPackage.Substring(0, ApkPackage.IndexOf("versionCode")).Replace("'", "")
                    End If

                    If line.Contains("application-label:") Then
                        ApkName = line.Substring(line.IndexOf(":") + 1).Replace("'", "")
                    ElseIf line.Contains("application-icon") Then
                        ApkName = line.Substring(line.IndexOf(":") + 1).Replace("'", "")
                    ElseIf line.Contains("application: label=") Then
                        ApkName = line.Substring(line.IndexOf("label=") + 6)

                        If ApkName.Contains("icon") Then
                            ApkName = ApkName.Substring(0, ApkName.IndexOf("icon") - 1).Replace("'", "")
                        End If

                        If ApkName.Contains("/") Then
                            ApkName = ApkName.Substring(ApkName.IndexOf("/"))
                        End If

                        ApkIcon = line.Substring(line.IndexOf("icon=") + 5).Replace("'", "")
                        Exit While

                    End If

                End While
            End Using

            'if apkname is unknow or nothing, get from apk filename
            Dim spl() As String = currentPath.Split("/")
            If ApkName = "Unknown" Or ApkName = "" Then
                ApkName = spl(spl.Length - 1).Replace(".apk", "")
            End If

            'if package name is nothing from aapt result, get from pm list packages
            If ApkPackage = "Cracked" Or ApkPackage = "" Then

                Using r As New StringReader(allPkgNames)
                    Dim line As String

                    While Not r.Peek = -1
                        line = r.ReadLine

                        If line.Contains(currentPath) Then
                            ApkPackage = line.Substring(line.IndexOf("=") + 1)
                        End If

                    End While
                End Using
            End If

            'get process is runing or not 
            If currentPath.StartsWith("/storage") Or currentPath.StartsWith("/mnt") Then
                ApkStatus = "Idle"
            Else

                Using r As New StringReader(allProcNames)
                    Dim line As String

                    While Not r.Peek = -1
                        line = r.ReadLine

                        Dim sp() As String = line.Split(" ")
                        Dim pkg As String = sp(sp.Length - 1)

                        If pkg.Contains(ApkPackage) Then
                            ApkStatus = "Active"
                            Exit While
                        End If

                    End While
                End Using
            End If

            'get, extract and copy apk icon
            If Not (ApkIcon = Nothing Or ApkIcon = "NoIcon") Then

                Dim iconName As String = spl(spl.Length - 1).Replace(".apk", ".png")

                Zip.Run7zCommand("e Temp\" & currentName & " -oTemp\ " & ApkIcon & " -r")
                Dim spr() As String = ApkIcon.Split("/")
                Dim name As String = spr(spr.Length - 1)
                If File.Exists("Temp\" & name) Then File.Move("Temp\" & name, "Temp\" & iconName)

                ApkIcon = iconName

            Else
                ApkIcon = "NoIcon"
            End If

        End If
    End Sub
    Private Sub getallPkgNames()
        allPkgNames = Adb.RunAdbShellCommand(Device, False, "pm list packages -f")
        allProcNames = Adb.RunAdbShellCommand(Device, False, "ps")
    End Sub
    Public Sub getPackageStatus()

        pkgStatus = "Idle"

        If allPkgNames = "" Then

            Dim bwkallPkgName As New BackgroundWorker
            AddHandler bwkallPkgName.DoWork, New DoWorkEventHandler(AddressOf getallPkgNames)
            bwkallPkgName.RunWorkerAsync()

            While bwkallPkgName.IsBusy
                Application.DoEvents()
                Threading.Thread.Sleep(100)
            End While

        End If

        Using r As New StringReader(allProcNames)
            Dim line As String

            While Not r.Peek = -1
                line = r.ReadLine

                Dim sp() As String = line.Split(" ")
                Dim pkg As String = sp(sp.Length - 1)

                If pkg.Contains(currentPath) Then
                    pkgStatus = "Active"
                    Exit While
                End If

            End While
        End Using

    End Sub

End Class
